<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="js/face-api.min.js"></script>
    <title>2DVtuber</title>
</head>

<body>
    <div style="position: relative" class="margin">
        <video onloadedmetadata="onPlay(this)" id="video" autoplay muted playsinline width="640" height=""></video>
        <canvas id="canvas"></canvas>
    </div>
    <script type="text/javascript">
        /**
         * 
         * @param {canvasElement} ctx 
         * @param {Array} points 
         * @param {boolean} isClosed 
         */
        function myDrawContour(
            ctx,
            points,
            isClosed = false
        )
        {
            ctx.beginPath();

            points.slice(1).forEach(({ x, y }, prevIdx) =>
            {
                const from = points[prevIdx];
                ctx.moveTo(from._x, from._y);
                ctx.lineTo(x, y);
            })

            if (isClosed)
            {
                const from = points[points.length - 1];
                const to = points[0];
                if (!from || !to)
                {
                    return;
                }

                ctx.moveTo(from._x, from._y);
                ctx.lineTo(to._x, to._y);
            }

            ctx.stroke();
        }

        /**
         * 
         */
        class MyFaceLandmarks
        {
            constructor(positions)
            {
                this.positions = positions;
            }
            getJawOutline()
            {
                return this.positions.slice(0, 17);
            }

            getLeftEyeBrow()
            {
                return this.positions.slice(17, 22);
            }

            getRightEyeBrow()
            {
                return this.positions.slice(22, 27);
            }

            getNose()
            {
                return this.positions.slice(27, 36);
            }

            getLeftEye()
            {
                return this.positions.slice(36, 42);
            }

            getRightEye()
            {
                return this.positions.slice(42, 48);
            }

            getMouth()
            {
                return this.positions.slice(48, 68);
            }
        }

        /**
         * 
         */
        class MyDrawFaceLandmarks
        {
            constructor(faceLandmarks)
            {
                this.faceLandmarks = new MyFaceLandmarks(faceLandmarks);
            }

            draw(ctx)
            {
                myDrawContour(ctx, this.faceLandmarks.getJawOutline());
                myDrawContour(ctx, this.faceLandmarks.getLeftEyeBrow());
                myDrawContour(ctx, this.faceLandmarks.getRightEyeBrow());
                myDrawContour(ctx, this.faceLandmarks.getNose());
                myDrawContour(ctx, this.faceLandmarks.getLeftEye(), true);
                myDrawContour(ctx, this.faceLandmarks.getRightEye(), true);
                myDrawContour(ctx, this.faceLandmarks.getMouth(), true);
            }
        }


        async function onPlay()
            {
                const videoEl = document.getElementById('video');

                const result = await faceapi.detectSingleFace(videoEl, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                console.log(result);

                if (result)
                {
                    const element = document.getElementById('canvas');
                    const canvas = element.getContext('2d');
                    const dims = faceapi.matchDimensions(element, videoEl, true);
                    const resizedResults = faceapi.resizeResults(result, dims);
                    console.log(resizedResults);
                    await new MyDrawFaceLandmarks(resizedResults['landmarks']['_positions']).draw(canvas);
                }

                setTimeout(() => onPlay());
            }
                async function run()
                    {
                        // load face detection and face landmark models
                        await faceapi.nets.tinyFaceDetector.load("models/");
                        await faceapi.nets.faceLandmark68Net.load("models/");
                        // try to access users webcam and stream the images
                        // to the video element
                        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                        const videoEl = document.getElementById('video');
                        videoEl.srcObject = stream;
                    }

                    function updateResults() { }

                    document.addEventListener('DOMContentLoaded',function ()
                    {
                        run();
                    })
                    
    </script>
</body>

</html>