<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
    <script src="js/face-api.min.js"></script>
    <title>2DVtuber</title>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
            data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="true"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse show" id="navbarColor01" style="">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <div class="form-group row">
                        <label for="inputEmail3" class="col-sm-2 col-form-label text-white">LineColor</label>
                        <div class="col-sm-10">
                            <input type="email" class="form-control" id="inputEmail3" placeholder="#000000">
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label text-white" for="defaultCheck1">
                            VideoInvisible
                        </label>
                        <div class="col-sm-10">
                            <input class="form-check-input h-75 w-75" type="checkbox" value="" id="defaultCheck1">
                        </div>
                    </div>
                </li>

            </ul>
            <form class="form-inline">
                <input class="form-control mr-sm-2" type="text" placeholder="Search">
                <button class="btn btn-outline-info my-2 my-sm-0" type="submit">Search</button>
            </form>
        </div>
    </nav>
    <div style="position: relative" class="margin">
        <video onloadedmetadata="onPlay(this)" id="video" autoplay muted playsinline
            style="position: absolute; top: 5px; z-index:0; "></video>
        <div style="position:absolute; top:5px; z-index:1; background:white; width:1280px; height:720px;"></div>
        <canvas id="canvas" style="position:absolute; top:5px; z-index:2;"></canvas>
    </div>
    <script type="text/javascript">
        /**
         * 
         * @param {canvasElement} ctx 
         * @param {Array} points 
         * @param {boolean} isClosed 
         */
        function myDrawContour(
            ctx,
            points,
            isClosed = false
        )
        {
            ctx.beginPath();

            points.slice(1).forEach(({ x, y }, prevIdx) =>
            {
                const from = points[prevIdx];
                ctx.moveTo(from._x, from._y);
                ctx.lineTo(x, y);
            })

            if (isClosed)
            {
                const from = points[points.length - 1];
                const to = points[0];
                if (!from || !to)
                {
                    return;
                }

                ctx.moveTo(from._x, from._y);
                ctx.lineTo(to._x, to._y);
            }

            ctx.stroke();
        }

        /**
         * 
         */
        class MyFaceLandmarks
        {
            constructor(positions)
            {
                this.positions = positions;
            }
            getJawOutline()
            {
                return this.positions.slice(0, 17);
            }

            getLeftEyeBrow()
            {
                return this.positions.slice(17, 22);
            }

            getRightEyeBrow()
            {
                return this.positions.slice(22, 27);
            }

            getNose()
            {
                return this.positions.slice(27, 36);
            }

            getLeftEye()
            {
                return this.positions.slice(36, 42);
            }

            getRightEye()
            {
                return this.positions.slice(42, 48);
            }

            getMouth()
            {
                return this.positions.slice(48, 68);
            }
        }

        /**
         * 
         */
        class MyDrawFaceLandmarks
        {
            constructor(faceLandmarks)
            {
                this.faceLandmarks = new MyFaceLandmarks(faceLandmarks);
            }

            draw(ctx)
            {
                myDrawContour(ctx, this.faceLandmarks.getJawOutline());
                myDrawContour(ctx, this.faceLandmarks.getLeftEyeBrow());
                myDrawContour(ctx, this.faceLandmarks.getRightEyeBrow());
                myDrawContour(ctx, this.faceLandmarks.getNose());
                myDrawContour(ctx, this.faceLandmarks.getLeftEye(), true);
                myDrawContour(ctx, this.faceLandmarks.getRightEye(), true);
                myDrawContour(ctx, this.faceLandmarks.getMouth(), true);
            }
        }


        async function onPlay()
        {
            const videoEl = document.getElementById('video');

            const result = await faceapi.detectSingleFace(videoEl, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();

            if (result)
            {
                const element = document.getElementById('canvas');
                const canvas = element.getContext('2d');
                const dims = faceapi.matchDimensions(element, videoEl, true);
                const resizedResults = faceapi.resizeResults(result, dims);
                await new MyDrawFaceLandmarks(resizedResults['landmarks']['_positions']).draw(canvas);
            }

            setTimeout(() => onPlay());
        }
        async function run()
        {
            // load face detection and face landmark models
            await faceapi.nets.tinyFaceDetector.load("models/");
            await faceapi.nets.faceLandmark68Net.load("models/");
            // try to access users webcam and stream the images
            // to the video element
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            const videoEl = document.getElementById('video');
            videoEl.srcObject = stream;
        }

        function updateResults() { }

        document.addEventListener('DOMContentLoaded', function ()
        {
            run();
        })

    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- 横長ヘッダー用 -->
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5397607715860650" data-ad-slot="2318919305"
        data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</body>

</html>